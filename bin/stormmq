#!/usr/bin/env ruby
# encoding: utf-8
#--
# Copyright (c) 2010, Tony Byrne & StormMQ Ltd.
# All rights reserved.
#
# Please refer to the LICENSE file that accompanies this source
# for terms of use and redistribution.
#++

$:.unshift File.dirname(__FILE__) + '/../lib'

begin
  require 'commander'
rescue LoadError
  require 'rubygems'
  require 'commander'
end

require 'yaml'
require 'stormmq'

program :version, '1.0.0'
program :description, 'StormMQ Ruby Client Console Application'
program :help, 'Author', 'Tony Byrne'
program :help, 'Copyright', 'Copyright 2010, Tony Byrne & StormMQ. All rights reserved.'

global_option('-u USER','--user USER','Specify the StormMQ user name to use (Hint: the user name that you registered with)
        If not provided the $STORMMQ_USER environment variable will be consulted instead')

command :apis do |c|
  c.syntax = "apis"
  c.description = "Describes all current APIs available in YAML format"
  c.when_called do |args, options|
    puts rest_client(options.user || ENV['STORMMQ_USER']).apis.to_yaml
  end
end

command :companies do |c|
  c.syntax = "companies"
  c.description = "Lists the companies available to you (typically one)"
  c.when_called do |args, options|
    puts rest_client(options.user || ENV['STORMMQ_USER']).companies
  end
end

command :systems do |c|
  c.syntax = "systems <company name>"
  c.description = "Lists all the systems known for a company"
  c.when_called do |args, options|
    puts rest_client(options.user || ENV['STORMMQ_USER']).systems(args[0]).each {|c| puts c}
  end
end


default_command :help

def rest_client(user)
  begin
    StormMQ::Rest.new(:user => user)
  rescue StormMQ::Error::UserNotProvidedError
    raise "Could not determine the user - either provide it via the --user option or set it via $STORMMQ_USER"
  rescue StormMQ::Error::SecretKeyNotProvidedError
    raise "Could not find the secret key for user '#{user}' - please ensure it is present in the secret key file"
  end
end
